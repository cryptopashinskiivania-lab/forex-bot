# Исправление проблемы с таймзонами ForexFactory

## Проблема

Бот неправильно интерпретировал время событий из ForexFactory, что приводило к:
- Сдвигу времени на 6-7 часов
- Пропуску новостей из-за неправильного фильтра по времени
- Отображению только 2 событий вместо 5-6

## Причина

**Корневая проблема**: ForexFactory определяет таймзону по IP-адресу сервера и возвращает время в **локальной таймзоне** (для Украины - `Europe/Kyiv`, GMT+2).

Старый код предполагал, что ForexFactory всегда возвращает `America/New_York`, но без принудительной установки таймзоны через cookie, ForexFactory возвращал время уже сконвертированное в GMT+2.

**Пример проблемы**:
- Реальное время события: **10:00am EST** = **17:00 Kyiv**
- ForexFactory без cookie возвращал: **5:00pm** (17:00 в 24h формате, уже киевское время)
- Бот интерпретировал `5:00pm` как **NY время** и конвертировал: 17:00 NY → 22:00 UTC → **00:00 Kyiv** ❌

Дополнительно был найден баг с **двойным преобразованием таймзоны**:
1. Использовал `dayjs.tz()` для парсинга времени с таймзоной NY
2. Затем снова передавал эти же значения в `fromZonedTime()` с таймзоной NY
3. Это усугубляло проблему неправильной интерпретации

## Решение

### 1. Добавлен cookie для принудительной установки таймзоны EST

В `src/services/CalendarService.ts`, метод `fetchEvents()`:

```typescript
const html = (await cloudscraper({
  uri: url,
  headers: {
    'User-Agent': '...',
    Accept: '...',
    'Accept-Language': 'en-US,en;q=0.5',
    'Cookie': 'fftimezone=America%2FNew_York', // ← ДОБАВЛЕН COOKIE
  },
})) as string;
```

Этот cookie **гарантирует**, что ForexFactory вернет время в `America/New_York` таймзоне, независимо от IP-адреса сервера.

### 2. Исправлена функция `parseTimeToISO`

#### Было (неправильно):
```typescript
// Парсинг с таймзоной NY
const parsed = dayjs.tz(combined, fmt, FF_TZ);
// Извлечение компонентов (уже с учетом таймзоны)
const year = parsed.year();
// ...
// Повторное преобразование (ДВОЙНОЕ ПРЕОБРАЗОВАНИЕ!)
const utcDate = fromZonedTime(dateString, FF_TZ);
```

#### Стало (правильно):
```typescript
// Парсинг БЕЗ таймзоны (как "наивное" время)
const parsed = dayjs(combined, fmt);
// Извлечение компонентов (это просто числа)
const year = parsed.year();
// ...
// ЕДИНСТВЕННОЕ преобразование из NY в UTC
const utcDate = fromZonedTime(dateString, FF_TZ);
```

## Логика работы

1. **Парсинг**: Время из HTML парсится как "наивное" (без таймзоны)
2. **Интерпретация**: Это время трактуется как `America/New_York` местное время
3. **Конвертация в UTC**: Используется `fromZonedTime()` для получения правильного UTC
4. **Сохранение**: UTC время сохраняется в БД
5. **Отображение**: При показе пользователю используется `toZonedTime()` для конвертации в `Europe/Kyiv`

## Пример

**ForexFactory показывает**: 10:00am (NY время)

**Преобразование**:
- UTC в БД: `2026-01-27T15:00:00.000Z` ✅
- Отображение пользователю (Kyiv): `17:00` ✅
- Разница: +7 часов (EST - зимнее время)

## Тестирование

Созданы тестовые скрипты:
- `scripts/test-timezone-fix.ts` - Тестирование логики преобразования
- `scripts/test-calendar-scrape.ts` - Тестирование на реальных данных из ForexFactory

**Команда для запуска теста**:
```bash
npx ts-node scripts/test-calendar-scrape.ts
```

## Результат

✅ Все времена корректно парсятся из `America/New_York`  
✅ UTC времена правильно сохраняются в базу данных  
✅ Времена в `Europe/Kyiv` правильно отображаются пользователю  
✅ Фильтры по времени работают корректно  
✅ Все новости теперь отображаются без пропусков
