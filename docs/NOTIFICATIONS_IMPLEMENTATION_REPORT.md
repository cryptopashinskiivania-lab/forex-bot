# –û—Ç—á—ë—Ç –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–ø–æ–≤–µ—â–µ–Ω–∏–π

–ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ `SchedulerService.ts`, `dailyMessage.ts`, `DataQualityService.ts`, `database.ts` –∏ —Å–≤—è–∑–∞–Ω–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.

---

## 1. –£—Ç—Ä–µ–Ω–Ω—è—è —Å–≤–æ–¥–∫–∞ –≤ 08:00

**–ì–¥–µ:** `src/services/SchedulerService.ts`, –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω—É—Ç—Ä–∏ `runScheduledCheck`.

**–ú–µ—Ç–æ–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

- **–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞:** `DAILY_SUMMARY_HOUR = 8` (—Å—Ç—Ä. 45).
- **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** –æ–¥–∏–Ω –æ–±—â–∏–π cron `*/3 * * * *` (–∫–∞–∂–¥—ã–µ 3 –º–∏–Ω—É—Ç—ã –ø–æ UTC). –û—Ç–¥–µ–ª—å–Ω–æ–≥–æ cron ¬´—Ç–æ–ª—å–∫–æ –≤ 08:00¬ª –Ω–µ—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ 08:00 –¥–µ–ª–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –æ–±—â–µ–≥–æ —Ü–∏–∫–ª–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- **–ú–æ–º–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏:** –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ –∫—Ä–æ–Ω–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—á–∏—Ç–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –≤ –µ–≥–æ —Ç–∞–π–º–∑–æ–Ω–µ (`toZonedTime(now, userTz)`). –£—Å–ª–æ–≤–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏:
  - `nowInUserTz.getHours() === DAILY_SUMMARY_HOUR` (—Å–µ–π—á–∞—Å 8-–π —á–∞—Å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è),
  - `!quiet` (–Ω–µ —Ç–∏—Ö–∏–π —Ä–µ–∂–∏–º),
  - `!database.hasSent(dailySummaryId)` (–µ—â—ë –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ —Å–≤–æ–¥–∫—É –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å).
- **–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä ¬´—É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ¬ª:** `daily8_${userId}_${todayDateStr}`, –≥–¥–µ `todayDateStr = format(nowInUserTz, 'yyyy-MM-dd')`. –û–¥–∏–Ω —Ä–∞–∑ –≤ –¥–µ–Ω—å –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- **–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:** —Ç–æ –∂–µ, —á—Ç–æ —É –∫–æ–º–∞–Ω–¥—ã `/daily`: `buildDailyMessage(userEvents, userTz, monitoredAssets)` –∏ `buildDailyKeyboard()` (–∫–Ω–æ–ø–∫–∏ ¬´AI Forecast¬ª / ¬´AI Results¬ª). –¢–µ–∫—Å—Ç —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –≤ `src/utils/dailyMessage.ts` (—Å–æ–±—ã—Ç–∏—è –∑–∞ —Å–µ–≥–æ–¥–Ω—è –ø–æ TZ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–ø–∏—Å–∫–∏ ForexFactory –∏ Myfxbook).

**–ò—Ç–æ–≥:** —É—Ç—Ä–µ–Ω–Ω—è—è —Å–≤–æ–¥–∫–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞: 08:00 –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ–¥–∏–Ω —Ä–∞–∑ –≤ –¥–µ–Ω—å, —Å —Ç–µ–º –∂–µ —Ñ–æ—Ä–º–∞—Ç–æ–º, —á—Ç–æ –∏ `/daily`. –û–∫–Ω–æ ‚Äî –≤–µ—Å—å —á–∞—Å 8 (–ª—é–±–∞—è –º–∏–Ω—É—Ç–∞ 08:xx –≤ TZ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –±–ª–∏–∂–∞–π—à–µ–º –∑–∞–ø—É—Å–∫–µ –∫—Ä–æ–Ω–∞).

---

## 2. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞ 15 –º–∏–Ω—É—Ç –¥–æ –≤—ã—Ö–æ–¥–∞ –Ω–æ–≤–æ—Å—Ç–∏

**–ì–¥–µ:** `src/services/SchedulerService.ts`, –±–ª–æ–∫ –¥–ª—è —Å–æ–±—ã—Ç–∏–π —Å `event.timeISO` –≤–Ω—É—Ç—Ä–∏ `runScheduledCheck`.

**–ú–µ—Ç–æ–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

- **–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞:** `REMINDER_MINUTES_BEFORE = 15` (—Å—Ç—Ä. 41).
- **–£—Å–ª–æ–≤–∏–µ:** —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–±—ã—Ç–∏–π —Å `event.timeISO`; –Ω–µ –≤ —Ç–∏—Ö–æ–º —Ä–µ–∂–∏–º–µ; –µ—â—ë –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ –∫–∞–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (`eventId = event_${userId}_${id}`).
- **–í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ:**  
  `reminderFrom = subMinutes(eventTime, 15)`,  
  –æ—Ç–ø—Ä–∞–≤–∫–∞ –µ—Å–ª–∏ `now >= reminderFrom && now <= eventTime`.  
  –¢–æ –µ—Å—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É—Ö–æ–¥–∏—Ç –æ–¥–∏–Ω —Ä–∞–∑, –∫–æ–≥–¥–∞ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª **[–∑–∞ 15 –º–∏–Ω—É—Ç –¥–æ —Å–æ–±—ã—Ç–∏—è; –≤—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è]**.
- **–ß–∞—Å—Ç–æ—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:** cron –∫–∞–∂–¥—ã–µ 3 –º–∏–Ω—É—Ç—ã (UTC). –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫, –ø–æ–ø–∞–≤—à–∏–π –≤ —ç—Ç–æ –æ–∫–Ω–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –ø–æ–º–µ—á–∞–µ—Ç `eventId` –≤ `sent_news`, –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–µ—Ç.
- **–§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:** —Ç–æ—Ç –∂–µ, —á—Ç–æ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è: –∑–∞–≥–æ–ª–æ–≤–æ–∫ ¬´–°–û–ë–´–¢–ò–ï¬ª, —Ñ–ª–∞–≥ –≤–∞–ª—é—Ç—ã, –∑–∞–≥–æ–ª–æ–≤–æ–∫, –∏—Å—Ç–æ—á–Ω–∏–∫, –æ—Ü–µ–Ω–∫–∞, AI-–∞–Ω–∞–ª–∏–∑ (—Å—É—Ç—å, –ª–æ–≥–∏–∫–∞, —Ñ–∞–∫—Ç/–ø—Ä–æ–≥–Ω–æ–∑ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏), —á–µ—Ä–µ–∑ `formatMessage` –∏ `analyzeNews`.

**–ò—Ç–æ–≥:** –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ ¬´–∑–∞ 15 –º–∏–Ω—É—Ç –¥–æ¬ª —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–∫–Ω–µ ¬´–æ—Ç 15 –º–∏–Ω—É—Ç –¥–æ —Å–æ–±—ã—Ç–∏—è –¥–æ –º–æ–º–µ–Ω—Ç–∞ —Å–æ–±—ã—Ç–∏—è¬ª, –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 3 –º–∏–Ω—É—Ç—ã, –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø–æ `event_${userId}_${id}`.

---

## 3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –≤—ã—à–µ–¥—à–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π

**–ì–¥–µ:** `src/services/SchedulerService.ts` (–±–ª–æ–∫ ¬´–†–ï–ó–£–õ–¨–¢–ê–¢¬ª) –∏ `src/services/DataQualityService.ts` (—á—Ç–æ–±—ã –ø—Ä–æ—à–µ–¥—à–∏–µ —Å–æ–±—ã—Ç–∏—è —Å —Ñ–∞–∫—Ç–æ–º –Ω–µ –æ—Ç—Å–µ–∫–∞–ª–∏—Å—å).

**–ú–µ—Ç–æ–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

- **–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã:** `RESULT_MINUTES_AFTER = 5` (—Å—Ç—Ä. 43); —Ä–µ–∑—É–ª—å—Ç–∞—Ç —à–ª—ë—Ç—Å—è —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–±—ã—Ç–∏—è.
- **–£—Å–ª–æ–≤–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏:**
  - —É —Å–æ–±—ã—Ç–∏—è –µ—Å—Ç—å `event.timeISO`;
  - –µ—Å—Ç—å ¬´—Ä–µ–∞–ª—å–Ω—ã–π¬ª —Ñ–∞–∫—Ç: `hasRealActual(event.actual)` (–Ω–µ –ø—É—Å—Ç–æ –∏ –Ω–µ placeholder –≤—Ä–æ–¥–µ `PENDING`);
  - –µ—â—ë –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç: `!database.hasSent(resultId)`, `resultId = result_${userId}_${id}`;
  - —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: `now >= resultFrom`, –≥–¥–µ `resultFrom = addMinutes(eventTime, 5)`.
- **–¢–∏—Ö–∏–π —Ä–µ–∂–∏–º:** –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —É—Ö–æ–¥—è—Ç –∏ –≤ —Ç–∏—Ö–∏–µ —á–∞—Å—ã (–≤ –∫–æ–¥–µ –Ω–µ—Ç `quiet` –¥–ª—è —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞).
- **–§–∏–ª—å—Ç—Ä –¥–∞–Ω–Ω—ã—Ö:** –≤ `DataQualityService.filterForDelivery` —Å `mode: 'general'`, `forScheduler: true` –ø—Ä–æ—à–µ–¥—à–∏–µ —Å–æ–±—ã—Ç–∏—è (—Å—Ç–∞—Ä—à–µ `PAST_THRESHOLD_SCHEDULER_MINUTES` = 2 —á–∞—Å–∞) –Ω–µ –æ—Ç—Å–µ–∫–∞—é—Ç—Å—è, –µ—Å–ª–∏ —É –Ω–∏—Ö –µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π actual (—Å—Ç—Ä. 378‚Äì381). –¢–∞–∫ —Å–æ–±—ã—Ç–∏—è ¬´—É–∂–µ –≤—ã—à–µ–¥—à–∞—è –Ω–æ–≤–æ—Å—Ç—å —Å —Ñ–∞–∫—Ç–æ–º¬ª –ø–æ–ø–∞–¥–∞—é—Ç –≤ `userEvents` –∏ –¥–æ—Ö–æ–¥—è—Ç –¥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–æ –Ω–∏–º —à–ª—ë—Ç ¬´–†–ï–ó–£–õ–¨–¢–ê–¢¬ª.
- **–§–æ—Ä–º–∞—Ç:** –∑–∞–≥–æ–ª–æ–≤–æ–∫ ¬´üìä –†–ï–ó–£–õ–¨–¢–ê–¢¬ª, —Ç–µ –∂–µ –ø–æ–ª—è (–∏—Å—Ç–æ—á–Ω–∏–∫, –≤–ª–∏—è–Ω–∏–µ, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, —Ñ–∞–∫—Ç/–ø—Ä–æ–≥–Ω–æ–∑, —Å—É—Ç—å, –ª–æ–≥–∏–∫–∞), AI-–∞–Ω–∞–ª–∏–∑ –ø–æ —Ç–µ–∫—Å—Ç—É —Å —É–∂–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–º actual.

**–ò—Ç–æ–≥:** —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–±—ã—Ç–∏—è, –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ä–µ–∞–ª—å–Ω–æ–≥–æ actual, –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ (`result_${userId}_${id}`), —Å —É—á—ë—Ç–æ–º —Ç–æ–≥–æ, —á—Ç–æ DataQualityService –æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤ –≤—ã–¥–∞—á–µ –ø—Ä–æ—à–µ–¥—à–∏–µ —Å–æ–±—ã—Ç–∏—è —Å —Ñ–∞–∫—Ç–æ–º –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞.

---

## –û–±—â–∞—è —Å—Ö–µ–º–∞

| –û–ø–æ–≤–µ—â–µ–Ω–∏–µ              | –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ / –æ–∫–Ω–æ              | –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤ `sent_news`   | Cron / –ø—Ä–æ–≤–µ—Ä–∫–∞        |
|-------------------------|-------------------------------|-------------------------------|------------------------|
| –£—Ç—Ä–µ–Ω–Ω—è—è —Å–≤–æ–¥–∫–∞ 08:00   | `DAILY_SUMMARY_HOUR = 8`     | `daily8_${userId}_${date}`   | –ö–∞–∂–¥—ã–µ 3 –º–∏–Ω (UTC)     |
| –ó–∞ 15 –º–∏–Ω –¥–æ –Ω–æ–≤–æ—Å—Ç–∏    | `REMINDER_MINUTES_BEFORE = 15` | `event_${userId}_${id}`     | –¢–æ –∂–µ                  |
| –†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–æ–≤–æ—Å—Ç–∏       | `RESULT_MINUTES_AFTER = 5`  | `result_${userId}_${id}`     | –¢–æ –∂–µ                  |

–í—Å–µ —Ç—Ä–∏ —Ç–∏–ø–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ –æ–¥–Ω–æ–º –º–µ—Ç–æ–¥–µ `runScheduledCheck(bot)`, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é `*/3 * * * *` (timezone: UTC) –∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (—á–µ—Ä–µ–∑ 15 —Å). –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å ‚Äî —á–µ—Ä–µ–∑ `database.hasSent(id)` / `database.markAsSent(id)` (—Ç–∞–±–ª–∏—Ü–∞ `sent_news`); –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π ‚Äî —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏ (—Å—Ç–∞—Ä—à–µ 24 —á) –≤ `database.cleanup()`.

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –ø–æ–≤–µ–¥–µ–Ω–∏—é –∏ –æ—Ç–ª–∞–¥–∫–µ: `docs/NOTIFICATIONS_DEBUG.md`, `NOTIFICATION_FIXES.md`, `ADMIN_COMMANDS.md`.
