# Проверка оповещений локально

## 0. Быстрая диагностика в боте

В Telegram отправьте боту команду **`/debug_notifications`**. Бот пришлёт отчёт:
- по каждому пользователю: таймзона, локальное время, тихий режим;
- количество событий из календаря после фильтров;
- для каждого пользователя: сколько событий без времени (могут быть отправлены как уведомления).

По отчёту видно, почему оповещения не уходят (нет событий, тихий режим, уже помечено как отправлено и т.д.).

## 1. Какие оповещения есть

- **События без времени** (all-day): отправляются один раз при проверке (крон каждые 3 мин), если не тихий режим.
- **События со временем:** напоминание за **15 минут** до времени события; после выхода новости — публикация **результата** (когда в календаре появился факт, через 5 мин после времени события).
- **RSS:** срочные новости из внешних источников (если включено в настройках), с учётом тихого режима.
- **Тихий режим 23:00–08:00** (по времени пользователя): в эти часы события и RSS не отправляются.

## 2. Как проверить логи

### Локально

1. Запустить бота: `npm run dev`.
2. Каждые 3 минуты в логах:
   - `[Scheduler] Running scheduled check...`
   - `[Scheduler] Processing notifications for N user(s)`
   - при отправке: `[Scheduler] Event sent to user X: ...` или `[Scheduler] RSS sent to user X: ...`
   - `[Scheduler] User X: events=... sent: events=... rss=...`

### На сервере в реальном времени (напоминания за ~15 мин, проверка каждые 3 мин)

Бот в продакшене запущен через PM2 (имя приложения: **forex-bot**).

**Смотреть все логи в реальном времени:**

```bash
pm2 logs forex-bot
```

**Только логи планировщика (события, RSS):**

```bash
pm2 logs forex-bot --raw | grep --line-buffered '\[Scheduler\]'
```

На Windows (PowerShell):

```powershell
pm2 logs forex-bot --raw 2>&1 | Select-String "\[Scheduler\]"
```

**Что искать:** каждые 3 минуты — `[Scheduler] Running scheduled check...`, затем по пользователям — `Event sent to user X: <название>` (напоминание отправлено), `User X: events=... sent: ...`.

**Последние 300 строк без потока:**

```bash
pm2 logs forex-bot --lines 300 --nostream
```

## 3. Возможные причины отсутствия оповещений

| Причина | Что проверить |
|--------|----------------|
| **Тихий режим 23:00–08:00** | В отчёте `/debug_notifications`: тихий=true — уведомления не шлются. В логах: `User X: ... quiet=true sent=0`. |
| **Нет событий без времени** | Автоматически отправляются **только события без времени** (all-day) и RSS. События с указанным временем (timeISO) не шлются по крону. В логах: `User X: events=N (without time: 0) ... sent=0`. |
| **Уже помечено как отправлено** | В БД: `sent` — один раз на `event_`, `rss_`. Повторно не шлётся. |
| **Нет событий по отслеживаемым валютам** | В настройках бота заданы «отслеживаемые активы». Если календарь не содержит их — событий для отправки 0. |
| **Неверный cwd/БД на сервере** | В логе старта: `[Startup] cwd=... | db=... | users=N`. Если users=0 или db не та — в ecosystem.config.js задать `cwd`. |
| **Ошибка при фетче/отправке** | В логах: `[Scheduler] Error sending event...`, ошибки CalendarService/MyfxbookService. |

**Что смотреть в логах после каждого цикла (каждые 3 мин):**  
`[Scheduler] Shared calendar: ForexFactory=... Myfxbook=...` — данные получены.  
`[Scheduler] User X: events=N (without time: M) quiet=... sent=0` — почему пользователю ничего не отправлено (M=0 или quiet=true).  
`[Scheduler] Scheduled check finished.` — цикл завершён.

## 4. Чек-лист на сервере (если оповещения не приходят в продакшене)

1. **Не убивается ли процесс?** В логах PM2 не должно быть частых рестартов. Проверить: `crontab -l`, скрипты деплоя/бэкапа.
2. **Правильный cwd и БД:** В логе при старте: `[Startup] cwd=/path/to/forex-news-bot | db=.../bot.db | users=N` (N > 0).
3. **Вызвать `/debug_notifications`** с аккаунта пользователя — проверить тихий режим, количество событий.

## 5. Деплой и проверка после исправлений (браузерная очередь)

Чтобы избежать массовых таймаутов и ошибок «browser has been closed», в коде добавлено:

- **Глобальная очередь браузерных запросов** (`src/utils/browserFetchLock.ts`): в один момент выполняется только один фетч через Playwright (ForexFactory или Myfxbook). Остальные ждут в очереди.
- **Планировщик** уже использует один общий фетч (`fetchSharedCalendarToday`) и раздаёт события пользователям через `getEventsForUserFromShared` (без дополнительных запусков браузера).
- **MyfxbookService:** таймаут `page.goto` увеличен до 30 с; закрытие страницы и контекста вынесено в `finally`.

**После деплоя на сервер:**

1. Закоммитить и запушить изменения, на сервере выполнить `git pull` и перезапуск приложения (например `pm2 restart forex-bot`).
2. В логах убедиться, что при проверке по крону виден один общий фетч, а не десятки параллельных:
   - Ожидаемо: `[CalendarService] Cache miss...` / `[MyfxbookService] Cache miss...` по одному разу за цикл, затем `[Scheduler] Processing notifications for N user(s)`.
   - Плохо: множество подряд `[CalendarService] Waiting for browser to launch...`, `Promise.allSettled (index 5)...(index 38)`, `page.goto: Timeout 15000ms exceeded`, `Target page, context or browser has been closed`.
3. Если ошибки остались — проверить, что на сервере действительно запущена новая версия кода (дата сборки, наличие `browserFetchLock.ts` в репозитории).
