# Исправления уведомлений (утренние и прочие)

## Выявленные и исправленные баги

### 1. Часовой пояс cron (критично)

**Проблема:** node-cron по умолчанию использует системный часовой пояс сервера. Если сервер в неожиданном поясе или TZ не настроен, рассылка в 08:00 могла не совпадать с окном для пользователей.

**Исправление:** Явно указан `timezone: 'UTC'` для обоих cron-задач. Расписание теперь однозначно: ежечасно в :00 UTC и каждые 3 минуты в UTC.

### 2. Слишком строгое окно 08:00

**Проблема:** Проверка `minute === 0` — при небольшой задержке запуска cron (например, 08:00:05) минута уже не 0 в части часовых поясов.

**Исправление:** Окно расширено до `hour === 8 && minute <= 4` (08:00–08:04).

### 3. Окно напоминаний за 15 минут

**Проблема:** Окно 14–16 минут при cron каждые 3 минуты — можно было пропустить отправку напоминания.

**Исправление:** Окно расширено до **12–18** минут до события (было 13–17), чтобы при запуске каждые 3 минуты хотя бы один запуск попадал в окно.

### 4. Перекрытие задач

**Проблема:** При долгой обработке (>1 ч) мог запускаться следующий daily digest до завершения предыдущего.

**Исправление:** Для daily digest добавлен `noOverlap: true`.

### 5. Результаты новостей не отправлялись (критично)

**Проблема:** В `filterForDelivery` с режимом `general` все события, которые произошли более чем 30 минут назад, отсекались. События с результатом (actual уже вышел) — это как раз прошедшие события, поэтому они никогда не попадали в список на отправку, и уведомления «Результат» не отправлялись.

**Исправление:** Прошедшие события с реальным actual (не placeholder) больше не отсекаются и остаются в списке на доставку — планировщик отправляет их как уведомление «Результат».

### 6. Обработка ошибок и логирование

**Добавлено:**
- Обработка ошибок для неверного timezone
- Логирование `sent` и `skipped` для daily digest
- Более информативные сообщения об ошибках при sendMessage

---

## Диагностика при отсутствии уведомлений

1. **Логи PM2:** `pm2 logs forex-bot` — смотреть `[Scheduler]` и ошибки.
2. **Первый запуск:** Через ~15 сек после старта бота выполняется проверка уведомлений. В логах должно быть:
   - `[Scheduler] Running initial notification check (on startup)...`
   - `[Scheduler] Processing notifications for N user(s)` (если N=0 — нет зарегистрированных пользователей)
   - Для каждого пользователя при 0 событиях: `User X: A total from calendar, B for monitored assets, C after quality filter` — по этим числам видно, на каком этапе теряются события (календарь пустой / нет активов / фильтр отсекает).
3. **Время на сервере:** `date` — для UTC должно быть корректно.
4. **Запись при рассылке:** В логах должно быть `[Scheduler] Running daily news at 08:00 for user X` и `Daily digest done: sent=X, skipped=Y`.
5. **Часовой пояс пользователя:** В БД в `user_settings` ключ `user_timezone` (по умолчанию Europe/Kyiv).
6. **Telegram:** Проверить, не заблокировал ли пользователь бота.

---

## Соответствие времени рассылки

| Часовой пояс пользователя | UTC, когда наступает 08:00 |
|---------------------------|----------------------------|
| Europe/Kyiv (UTC+2)       | 06:00 UTC                  |
| Europe/Moscow (UTC+3)     | 05:00 UTC                  |
| America/New_York (UTC-5)  | 13:00 UTC                  |

Cron daily digest выполняется в :00 каждого часа UTC. В один из этих моментов для каждого пользователя локально наступает 08:00.
