# Исправления уведомлений (утренние и прочие)

## Выявленные и исправленные баги

### 1. Часовой пояс cron (критично)

**Проблема:** node-cron по умолчанию использует системный часовой пояс сервера. Если сервер в неожиданном поясе или TZ не настроен, рассылка в 08:00 могла не совпадать с окном для пользователей.

**Исправление:** Явно указан `timezone: 'UTC'` для обоих cron-задач. Расписание теперь однозначно: ежечасно в :00 UTC и каждые 3 минуты в UTC.

### 2. Слишком строгое окно 08:00

**Проблема:** Проверка `minute === 0` — при небольшой задержке запуска cron (например, 08:00:05) минута уже не 0 в части часовых поясов.

**Исправление:** Окно расширено до `hour === 8 && minute <= 4` (08:00–08:04).

### 3. Окно напоминаний за 15 минут

**Проблема:** Окно 14–16 минут при cron каждые 3 минуты — можно было пропустить отправку напоминания.

**Исправление:** Окно расширено до 13–17 минут.

### 4. Перекрытие задач

**Проблема:** При долгой обработке (>1 ч) мог запускаться следующий daily digest до завершения предыдущего.

**Исправление:** Для daily digest добавлен `noOverlap: true`.

### 5. Обработка ошибок и логирование

**Добавлено:**
- Обработка ошибок для неверного timezone
- Логирование `sent` и `skipped` для daily digest
- Более информативные сообщения об ошибках при sendMessage

---

## Диагностика при отсутствии уведомлений

1. **Логи PM2:** `pm2 logs forex-bot` — смотреть `[Scheduler]` и ошибки.
2. **Время на сервере:** `date` — для UTC должно быть корректно.
3. **Запись при рассылке:** В логах должно быть `[Scheduler] Running daily news at 08:00 for user X` и `Daily digest done: sent=X, skipped=Y`.
4. **Часовой пояс пользователя:** В БД в `user_settings` ключ `user_timezone` (по умолчанию Europe/Kyiv).
5. **Telegram:** Проверить, не заблокировал ли пользователь бота.

---

## Соответствие времени рассылки

| Часовой пояс пользователя | UTC, когда наступает 08:00 |
|---------------------------|----------------------------|
| Europe/Kyiv (UTC+2)       | 06:00 UTC                  |
| Europe/Moscow (UTC+3)     | 05:00 UTC                  |
| America/New_York (UTC-5)  | 13:00 UTC                  |

Cron daily digest выполняется в :00 каждого часа UTC. В один из этих моментов для каждого пользователя локально наступает 08:00.
