# ‚úÖ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ aggregateCoreEvents - –û—Ç—á–µ—Ç –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏

**–î–∞—Ç–∞:** 29 —è–Ω–≤–∞—Ä—è 2026  
**–ó–∞–¥–∞—á–∞:** #3 –∏–∑ DATA_QUALITY_AUDIT_REPORT.md  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

---

## üéØ –¶–µ–ª—å

–£—Å—Ç—Ä–∞–Ω–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ `aggregateCoreEvents` –≤ `bot.ts` –∏ `SchedulerService.ts`, –∫–æ—Ç–æ—Ä—ã–µ –∏–º–µ–ª–∏ —Ä–∞–∑–Ω—É—é –ª–æ–≥–∏–∫—É –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π.

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

### –î–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:

**–í `bot.ts:112-182`:**
- –ü—Ä–æ—Å—Ç–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
- ForexFactory –∏–º–µ–µ—Ç –±–µ–∑—É—Å–ª–æ–≤–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
- Myfxbook —Å–æ–±—ã—Ç–∏—è –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã
- **–ù–µ –≤—ã–±–∏—Ä–∞–µ—Ç –ª—É—á—à–µ–µ —Å–æ–±—ã—Ç–∏–µ** –ø—Ä–∏ –¥—É–±–ª–∏–∫–∞—Ç–∞—Ö

**–í `SchedulerService.ts:68-138`:**
- **–£–º–Ω–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è** —Å –≤—ã–±–æ—Ä–æ–º –ª—É—á—à–µ–≥–æ —Å–æ–±—ã—Ç–∏—è:
  - –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è —Å actual/forecast –¥–∞–Ω–Ω—ã–º–∏
  - –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç High impact –Ω–∞–¥ Medium/Low
  - –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç ForexFactory –∫–∞–∫ –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫

### –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:

‚ùå –†–∞–∑–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è `/daily` –∏ scheduler  
‚ùå –£–º–Ω–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –≤ bot.ts  
‚ùå –ö–æ–¥ —Å–ª–æ–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å  
‚ùå –†–∏—Å–∫ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –°–æ–∑–¥–∞–Ω shared –º–æ–¥—É–ª—å

**–§–∞–π–ª:** `src/utils/eventAggregation.ts`

```typescript
export async function aggregateCoreEvents(
  calendarService: CalendarService,
  myfxbookService: MyfxbookService,
  userId: number,
  forTomorrow: boolean = false
): Promise<CalendarEvent[]>
```

### 2. –£–º–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏

–°–æ–±—ã—Ç–∏—è —Å—á–∏—Ç–∞—é—Ç—Å—è –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏, –µ—Å–ª–∏:
- –í—Ä–µ–º—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 5 –º–∏–Ω—É—Ç (–æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ)
- –í–∞–ª—é—Ç–∞ –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è

–ü—Ä–∏ –≤—ã–±–æ—Ä–µ –º–µ–∂–¥—É –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è **–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã** (–≤ –ø–æ—Ä—è–¥–∫–µ –≤–∞–∂–Ω–æ—Å—Ç–∏):

1. **–ù–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö:** –°–æ–±—ã—Ç–∏–µ —Å actual/forecast > —Å–æ–±—ã—Ç–∏–µ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö
2. **Impact:** High > Medium > Low
3. **–ò—Å—Ç–æ—á–Ω–∏–∫:** ForexFactory > Myfxbook (–ø—Ä–∏ —Ä–∞–≤–Ω–æ–º –∫–∞—á–µ—Å—Ç–≤–µ)

### 3. –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```typescript
[EventAggregation] User 123 | Source: Both | Today | ForexFactory: 15, Myfxbook: 12
[EventAggregation] Replaced duplicate: "NFP" (Myfxbook) ‚Üí "Non-Farm Payrolls" (ForexFactory)
[EventAggregation] User 123 | Source: Both | Today | Total after deduplication: 20 events
```

---

## üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### ‚úÖ –°–æ–∑–¥–∞–Ω–æ

- `src/utils/eventAggregation.ts` (156 —Å—Ç—Ä–æ–∫)
  - –§—É–Ω–∫—Ü–∏—è `aggregateCoreEvents`
  - –§—É–Ω–∫—Ü–∏—è `deduplicationKey`
  - –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (`md5`, `isEmpty`)

### ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ

**`src/bot.ts`:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç: `import { aggregateCoreEvents } from './utils/eventAggregation'`
- ‚úÖ –£–¥–∞–ª–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `aggregateCoreEvents` (71 —Å—Ç—Ä–æ–∫–∞)
- ‚úÖ –£–¥–∞–ª–µ–Ω—ã –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (`md5`, `deduplicationKey`)
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ **7 –≤—ã–∑–æ–≤–æ–≤**:
  - `/daily` command (—Å—Ç—Ä–æ–∫–∞ 164)
  - `daily_ai_forecast` callback (—Å—Ç—Ä–æ–∫–∞ 243)
  - `daily_ai_results` callback (—Å—Ç—Ä–æ–∫–∞ 308)
  - `tomorrow_ai_forecast` callback (—Å—Ç—Ä–æ–∫–∞ 365)
  - `/calendar` command (—Å—Ç—Ä–æ–∫–∞ 423)
  - `/tomorrow` command (—Å—Ç—Ä–æ–∫–∞ 460)
  - `processQuestion` helper (—Å—Ç—Ä–æ–∫–∞ 567)

**`src/services/SchedulerService.ts`:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç: `import { aggregateCoreEvents } from '../utils/eventAggregation'`
- ‚úÖ –£–¥–∞–ª–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `aggregateCoreEvents` (71 —Å—Ç—Ä–æ–∫–∞)
- ‚úÖ –£–¥–∞–ª–µ–Ω—ã –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (`deduplicationKey`, `isEmpty`)
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ **2 –≤—ã–∑–æ–≤–∞**:
  - Daily digest task (—Å—Ç—Ä–æ–∫–∞ 365)
  - Scheduled check task (—Å—Ç—Ä–æ–∫–∞ 457)

---

## ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### TypeScript Compilation

```bash
$ npx tsc --noEmit
‚úÖ No errors
```

### Linter

```bash
$ ReadLints
‚úÖ No linter errors found
```

### Integration Test

```bash
$ npx ts-node scripts/test-calendar-scrape.ts
‚úÖ Events correctly parsed and deduplicated
‚úÖ Times correctly parsed from America/New_York timezone
‚úÖ UTC times saved to database
‚úÖ Kyiv times displayed to users
```

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –£–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞

‚úÖ **–ï–¥–∏–Ω–∞—è –ª–æ–≥–∏–∫–∞** - –Ω–µ—Ç —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –º–µ–∂–¥—É `/daily` –∏ scheduler  
‚úÖ **–£–º–Ω–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è** - –≤—Å–µ–≥–¥–∞ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –ª—É—á—à–µ–µ —Å–æ–±—ã—Ç–∏–µ  
‚úÖ **–õ–µ–≥–∫–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏** - –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ  
‚úÖ **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –≤–∏–¥–Ω–æ, –∫–∞–∫–∏–µ —Å–æ–±—ã—Ç–∏—è –∑–∞–º–µ–Ω—è—é—Ç—Å—è –∏ –ø–æ—á–µ–º—É  
‚úÖ **–¢–∏–ø–∏–∑–∞—Ü–∏—è** - —Ñ—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏  

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–¥–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
|---------|-----|-------|-----------|
| –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ | 142 —Å—Ç—Ä–æ–∫–∏ (2 –º–µ—Å—Ç–∞) | 0 —Å—Ç—Ä–æ–∫ | -100% |
| –°—Ç—Ä–æ–∫ –≤ bot.ts | 1145 | 1078 | -67 —Å—Ç—Ä–æ–∫ |
| –°—Ç—Ä–æ–∫ –≤ SchedulerService.ts | 653 | 585 | -68 —Å—Ç—Ä–æ–∫ |
| –ù–æ–≤—ã–π –º–æ–¥—É–ª—å | 0 | 156 —Å—Ç—Ä–æ–∫ | +156 —Å—Ç—Ä–æ–∫ |
| **–ò–¢–û–ì–û** | 1798 | 1819 | +21 —Å—Ç—Ä–æ–∫–∞ |

*–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: +21 —Å—Ç—Ä–æ–∫–∞ –∑–∞ —Å—á–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤*

---

## üîç –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞

### –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞ –¥–ª—è Junior —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞:**
- –ü–æ–Ω—è—Ç–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ö–Ω–∏–∫
- –ß–µ—Ç–∫–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
- –õ–æ–≥–∏—á–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

‚úÖ **–ë–µ–∑ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏:**
- –ü—Ä–æ—Å—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ Map/Set
- –Ø–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞

‚úÖ **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- –í–∏–¥–Ω–æ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
- –õ–µ–≥–∫–æ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã

---

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω. –§—É–Ω–∫—Ü–∏—è `aggregateCoreEvents` —Ç–µ–ø–µ—Ä—å:

1. ‚úÖ –ù–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –µ–¥–∏–Ω–æ–º shared –º–æ–¥—É–ª–µ
2. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —É–º–Ω—É—é –ª–æ–≥–∏–∫—É –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
3. ‚úÖ –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤–µ–∑–¥–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ
4. ‚úÖ –•–æ—Ä–æ—à–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞
5. ‚úÖ –õ–µ–≥–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–¥–∞—á–∞–º #4-#6 (–í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢) –∏–∑ DATA_QUALITY_AUDIT_REPORT.md
