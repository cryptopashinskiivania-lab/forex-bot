# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—ã–±–æ—Ä–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π

## –û–±–∑–æ—Ä

–î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–±–æ—Ä–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –≤—ã–±–∏—Ä–∞—Ç—å –º–µ–∂–¥—É:
- **ForexFactory** - –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫
- **Myfxbook** - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
- **–û–±–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞** - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (`src/db/database.ts`)

–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –Ω–æ–≤–æ—Å—Ç–µ–π:

```typescript
// –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ –Ω–æ–≤–æ—Å—Ç–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
getNewsSource(userId: number): 'ForexFactory' | 'Myfxbook' | 'Both'

// –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ –Ω–æ–≤–æ—Å—Ç–µ–π
setNewsSource(userId: number, source: 'ForexFactory' | 'Myfxbook' | 'Both'): void
```

**–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é**: `'Both'` (–æ–±–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞)

### 2. –°–µ—Ä–≤–∏—Å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ (`src/services/SchedulerService.ts`)

–§—É–Ω–∫—Ü–∏—è `aggregateCoreEvents()` —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä `userId`:

```typescript
async function aggregateCoreEvents(
  calendarService: CalendarService,
  myfxbookService: MyfxbookService,
  userId: number  // –ù–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
): Promise<CalendarEvent[]>
```

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã**:
- –ü–æ–ª—É—á–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è —Ç–æ–ª—å–∫–æ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ - –≤—Ç–æ—Ä–æ–π –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
- –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ "–û–±–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞"

### 3. –ë–æ—Ç (`src/bot.ts`)

#### –§—É–Ω–∫—Ü–∏—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
```typescript
async function aggregateCoreEvents(
  forTomorrow: boolean = false,
  userId?: number  // –ù–æ–≤—ã–π –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
): Promise<CalendarEvent[]>
```

#### –ù–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

1. **–ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞** (`settings_news_source`)
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
   - –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫

2. **–í—ã–±–æ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–∞** (`source_forexfactory`, `source_myfxbook`, `source_both`)
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –û–±–Ω–æ–≤–ª—è–µ—Ç –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏

3. **–ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"** (`settings_back`)
   - –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫

#### –û–±–Ω–æ–≤–ª–µ–Ω–æ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫

–ú–µ–Ω—é `/settings` —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ –∞–∫—Ç–∏–≤—ã
- –¢–∏—Ö–∏–π —Ä–µ–∂–∏–º
- **–ò—Å—Ç–æ—á–Ω–∏–∫ –Ω–æ–≤–æ—Å—Ç–µ–π** (–Ω–æ–≤–æ–µ!)

### 4. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

–ë–ª–∞–≥–æ–¥–∞—Ä—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –∫—ç—à—É –≤ `CalendarService` –∏ `MyfxbookService` (5 –º–∏–Ω—É—Ç TTL):
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –æ–¥–Ω–æ–º—É –∏—Å—Ç–æ—á–Ω–∏–∫—É –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –∏–∑ –∫—ç—à–∞
- –ù–µ—Ç –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤
- –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É `/settings`
2. –ù–∞–∂–∞—Ç—å –Ω–∞ –∫–Ω–æ–ø–∫—É "üì° –ò—Å—Ç–æ—á–Ω–∏–∫ –Ω–æ–≤–æ—Å—Ç–µ–π"
3. –í—ã–±—Ä–∞—Ç—å –∂–µ–ª–∞–µ–º—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫:
   - üì∞ ForexFactory
   - üìä Myfxbook
   - üîÑ –û–±–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞

### –ü–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

- **Daily news (08:00)**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–ú–∏–Ω—É—Ç–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–∫–∞–∂–¥—ã–µ 3 –º–∏–Ω—É—Ç—ã)**: –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–ö–æ–º–∞–Ω–¥—ã** (`/daily`, `/tomorrow`): –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **AI –∞–Ω–∞–ª–∏–∑**: —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Å–æ–±—ã—Ç–∏—è–º–∏ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ì–∏–±–∫–æ—Å—Ç—å** - –∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —É–¥–æ–±–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
2. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è** - –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç—Å—è –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
3. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "–û–±–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞" (–∫–∞–∫ –±—ã–ª–æ —Ä–∞–Ω—å—à–µ)
4. **–ù–µ –ª–æ–º–∞–µ—Ç –ª–æ–≥–∏–∫—É** - –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –ø—Ä–µ–∂–¥–µ
5. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –•—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `user_settings`:
```sql
user_id | key          | value
--------|--------------|-------------
123456  | news_source  | 'Both'
```

### –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è

–ü—Ä–∏ –≤—ã–±–æ—Ä–µ "–û–±–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞":
- ForexFactory –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
- Myfxbook –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–ª—é—á –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏: `md5(roundedTime + currency)`

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **–ö—ç—à**: 5 –º–∏–Ω—É—Ç –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫
- **–ó–∞–ø—Ä–æ—Å—ã**: –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ (Promise.all)
- **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –∏—Å—Ç–æ—á–Ω–∏–∫ –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è, –µ—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω

## –ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤

```
[Scheduler] User 123456 | Source: Both | ForexFactory: 15, Myfxbook: 8
[Scheduler] User 123456 | Source: ForexFactory | ForexFactory: 15, Myfxbook: 0
[Bot] User 123456 | Source: Myfxbook | ForexFactory events: 0, Myfxbook events: 8
```
