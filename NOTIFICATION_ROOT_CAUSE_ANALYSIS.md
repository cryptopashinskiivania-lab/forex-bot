# Анализ: почему уведомления перестали работать после деплоя

## Хронология коммитов (от новых к старым)

| Коммит     | Описание |
|-----------|----------|
| 409e897   | Fix morning notifications (UTC, 08:00 window, docs) |
| 1c79e28   | **fix: do not show RESULT with Fact PENDING** (placeholder = no data) |
| c6fe9f1   | Deploy: backup, PM2, deploy-update |
| 0088f2d   | Scaling and optimization |
| 9bcdf9d   | **feat: implement comprehensive data quality system** (DataQualityService, filterForDelivery) |
| 79b1453   | **refactor: unify aggregateCoreEvents** + подключение filterForDelivery в Scheduler |

---

## Причина поломки

### 1. Введение фильтра доставки (коммиты 9bcdf9d и 79b1453)

- **9bcdf9d** добавил `DataQualityService` и метод **`filterForDelivery`**.
- В нём для режима **`general`** введено правило: отсекать события, которые произошли **более чем 30 минут назад** (PAST_TOO_FAR).
- **79b1453** перевёл планировщик на общий `aggregateCoreEvents` и **обязательно** прогоняет события через этот фильтр:

```ts
const { deliver: userEvents } = this.dataQualityService.filterForDelivery(
  userEventsRaw,
  { mode: 'general', nowUtc: new Date() }
);
```

До этого планировщик работал с полным списком событий по активам пользователя **без** отсечения по времени. После — только с теми, что прошли `filterForDelivery`.

### 2. Конфликт с типом «Результат новости»

- Уведомление **«Результат»** должно отправляться, когда по событию уже вышел **actual** (факт).
- Такие события по времени уже **в прошлом** (час, два и т.д.).
- В `filterForDelivery` для `general` все события с `diffMinutes > 30` помечались как PAST_TOO_FAR и **выкидывались** из `deliver`.
- В итоге события с результатом **никогда не попадали** в `userEvents`, блок `if (event.isResult)` в планировщике по ним не выполнялся — **уведомления «Результат» перестали уходить**.

То есть проблема появилась не из‑за «последнего деплоя» в узком смысле (c6fe9f1), а из‑за того, что **в прод попала связка**: Data Quality (9bcdf9d) + рефакторинг планировщика с filterForDelivery (79b1453). После этого деплоя уведомления «Результат» и перестали работать.

### 3. Коммит 1c79e28 (PENDING / placeholder)

- Уже **после** поломки: ужесточена проверка «есть ли реальный actual» (не PENDING, не пусто).
- Менялись только режим **`ai_results`** и учёт placeholder в DataQualityService.
- На режим **`general`** и на отсечение по PAST_TOO_FAR этот коммит **не влиял**.
- То есть 1c79e28 **не причина** отключения уведомлений, но он мог дополнительно ужесточить отбор по actual в других местах (например, в кнопках AI Results).

---

## Что именно сломалось

| Тип уведомления              | Причина поломки |
|-----------------------------|------------------|
| **Результат новости**       | События с actual отфильтровывались как PAST_TOO_FAR в `filterForDelivery(mode: 'general')`, в планировщик не попадали. |
| **Напоминание за 15 мин**    | Логика окна 13–17 мин при cron каждые 3 мин могла «промахиваться»; плюс могли отсекаться события на границе (расширение окна до 12–18 мин это смягчает). |
| **Сводка в 8:00**           | Тот же фильтр мог обрезать часть утренних событий (если считались «прошлыми» по UTC); плюс возможные нюансы с временем запуска cron (добавлено логирование). |

Главный конфликт: **одно и то же правило** «не отдавать события старше 30 минут» использовалось и для очистки мусора, и для всей ленты планировщика, из‑за чего из потока выпали **именно результаты**.

---

## Внесённые исправления

1. **DataQualityService.filterForDelivery (mode: 'general')**  
   События, которые «в прошлом» более чем на 30 минут, **не отсекаются**, если у них есть **реальный actual** (не пусто и не placeholder). Такие события по‑прежнему попадают в `deliver` и планировщик отправляет по ним уведомление «Результат».

2. **Окно напоминания**  
   Расширено с 13–17 до **12–18** минут до события, чтобы при cron каждые 3 минуты хотя бы один запуск попадал в окно.

3. **Сводка в 8:00**  
   Добавлено логирование срабатывания крона (`Daily digest cron fired at ... UTC`) для проверки времени запуска.

4. **Первый запуск проверки при старте**  
   Через ~15 сек после старта выполняется та же проверка, что и по крону (логи, диагностика).

---

## Вывод

- Проблема появилась **после деплоя коммитов с Data Quality и рефакторингом планировщика** (9bcdf9d + 79b1453), а не из‑за «последнего» деплоя (c6fe9f1) или коммита 1c79e28.
- Конфликт: **filterForDelivery** отсекал все события старше 30 минут, в том числе события с вышедшим actual, которые нужны для уведомлений «Результат».
- Исправление: в режиме `general` не отсекать прошедшие события, у которых есть реальный actual; остальные правки (окно напоминания, логи) улучшают надёжность и диагностику.
